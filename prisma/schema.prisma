// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================
// LEGACY TABLES SUPPORT (AUTH SYSTEM)
// ==========================================

model AdminUser {
  id               Int       @id @default(autoincrement())
  email            String    @unique
  password_hash    String
  name             String
  is_super_admin   Boolean   @default(false)
  is_active        Boolean   @default(true)
  last_login_at    DateTime?
  created_at       DateTime  @default(now())

  @@map("admin_users")
}

model CoffeeGrower {
  id                    Int       @id @default(autoincrement())
  identification_number String?
  identification_type   String?
  full_name             String
  email                 String    @unique
  password_hash         String
  status                String    @default("active")
  created_by            String?
  created_at            DateTime  @default(now())
  
  // Relaciones
  farms                 FarmLegacy[]

  @@map("coffee_growers")
}

// Renaming generic Farm to match legacy if needed, or mapping legacy farm to this
model FarmLegacy {
  id               Int          @id @default(autoincrement())
  name             String
  coffee_grower_id Int
  status           String       @default("active")
  
  coffeeGrower     CoffeeGrower @relation(fields: [coffee_grower_id], references: [id])

  @@map("farms")
}

// ==========================================
// END LEGACY TABLES 
// ==========================================


// Modelo de Usuario/Perfil
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      String   @default("TRABAJADOR") // Was Enum UserRole
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// Modelo de Finca (Modern)
model Farm {
  id          String  @id @default(cuid())
  name        String
  location    String
  area        Float // en hect├íreas
  altitude    Float? // metros sobre el nivel del mar
  coordinates String? // JSON con coordenadas GPS
  description String?
  ownerId     String
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Fields for Configuration/Dashboard
  department       String?
  municipality     String?
  address          String?
  soilType         String? @map("soil_type")
  processingMethod String? @map("processing_method")
  coffeeVarieties  String? @map("coffee_varieties") // CSV string

  workers     FarmWorker[]

  @@map("farms_modern") // Renamed to avoid collision with legacy
}


// Modelo de Colaborador
model FarmWorker {
  id        String   @id @default(cuid())
  farmId    String
  name      String
  role      String   @default("RECOLECTOR")
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  farm      Farm     @relation(fields: [farmId], references: [id])
  collections CoffeeCollection[]
  tasks       WorkerTask[]

  @@map("farm_workers")
}

// Modelo de Recolecci├│n de Caf├®
model CoffeeCollection {
  id             String   @id @default(cuid())
  workerId       String
  lotId          String
  quantityKg     Float
  collectionDate DateTime @default(now())
  method         String   @default("MANUAL") // MANUAL, BASCULA
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  worker         FarmWorker @relation(fields: [workerId], references: [id])
  
  @@index([workerId])
  @@index([lotId])
  @@map("coffee_collections")
}

// Modelo de Tareas Asignadas
model WorkerTask {
  id          String   @id @default(cuid())
  workerId    String
  type        String // FERTILIZACION, PODA, LIMPIEZA, OTRO
  description String
  status      String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, CANCELLED
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  worker      FarmWorker @relation(fields: [workerId], references: [id])

  @@map("worker_tasks")
}

// Modelo de Insumos (Catßlogo)
model Input {
  id                      Int      @id @default(autoincrement())
  name                    String   @unique
  type                    String
  brand                   String?
  activeIngredient        String?
  concentration           String?
  unit                    String
  carencyPeriod           Int?
  reentryPeriod           Int?
  maxApplicationsPerCycle Int?
  dosagePerHectare        Float?
  description             String?
  safetyInstructions      String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  inventory  Inventory[]
  inputUsage InputUsage[]
  
  @@map("inputs")
}

// Modelo de Inventario (Existencias)
model Inventory {
  id             Int       @id @default(autoincrement())
  inputId        Int
  quantity       Float
  unitCost       Float
  supplier       String
  purchaseDate   DateTime
  expirationDate DateTime?
  batchNumber    String?
  location       String?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  input      Input        @relation(fields: [inputId], references: [id])
  inputUsage InputUsage[]

  @@map("inventory")
}

// Modelo de Uso de Insumos
model InputUsage {
  id                 Int      @id @default(autoincrement())
  inventoryId        Int
  inputId            Int?
  agriculturalTaskId Int?
  quantityUsed       Float
  notes              String?
  createdAt          DateTime @default(now())

  inventory        Inventory         @relation(fields: [inventoryId], references: [id])
  input            Input?            @relation(fields: [inputId], references: [id])
  // agriculturalTask AgriculturalTask? @relation(fields: [agriculturalTaskId], references: [id])

  @@map("input_usage")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    String   // Stores ID of CoffeeGrower (Int as String) or AdminUser
  type      String   // 'analysis_complete', 'urgent_alert', 'recommendation', 'system_update'
  agentType String   // 'phytosanitary', 'predictive', 'rag_assistant', 'optimization'
  title     String
  message   String
  priority  String   // 'low', 'medium', 'high', 'critical'
  read      Boolean  @default(false)
  data      String?  // JSON string
  createdAt DateTime @default(now())

  // No strict relation to support multiple user tables (CoffeeGrower, AdminUser) without polymorphism complexity
  
  @@map("notifications")
}